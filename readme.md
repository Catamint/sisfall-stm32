# STM32+MPU6050 SVM跌倒检测装置

## 1. 系统结构与核心原理

本系统基于STM32单片机和MPU6050六轴传感器，结合SVM模型实现跌倒检测。采用双定时器中断机制采集加速度和角速度数据，利用滑动窗口提取特征并进行分类预测，实现高效、异步、无阻塞的数据采集、特征提取与预测。

项目文件可用vscode+eide打开。

---

## 2. 主要功能模块

系统采用基于中断+主循环的架构设计，核心包括两个定时器中断服务（TIM2、TIM3）及主循环状态机。
### 2.1 TIM2中断（数据采集与窗口管理，周期20ms）

- 功能：每20ms采集MPU6050的加速度和角速度数据，储存在数据窗口中，并更新队列指针。若`report_flag = 1`，则按自定义协议通过串口上传，便于上位机分析。
- **数据窗口**：采用长度150的循环队列（window），仅使用100个数据点作为有效窗口。
- **队列指针**：window_head和window_tail指针循环递增，始终保持两者之差为100，实现滑动窗口。
- 操作流程：
	1. 采集MPU6050的加速度和角速度数据，写入滑动窗口数组 `window[window_head]`
	2. 更新指针 `window_head` 和 `window_tail`，以模拟循环队列，保持窗口大小恒定为100
	3. 若`report_flag = 1`，则按自定义协议通过串口上传，便于上位机分析。
### 2.2 TIM3中断（执行周期性任务，周期500ms）

- 功能：执行周期性任务
	- 设置预测标志 `predict_flag = 1`
	- 更新屏幕显示内容
	- 控制报警器和LED状态
- **预测标志：TIM3中断仅设置预测标志，不直接进行耗时的预测操作，保证中断响应及时。**
- 报警逻辑：
	- 若全局变量 `alarm_flag > 0`，则设置 `BEEP = !BEEP`转换蜂鸣器状态，并使`alarm_flag - 1`
	- 若 `alarm_flag <= 0`，则关闭蜂鸣器 `BEEP = 0`
### 2.3 主循环逻辑

- 功能：主循环检测预测标志，若为1则保存当前window_head和window_tail，提取窗口内100组数据进行特征计算和SVM预测。
- 流程：若 `predict_flag == 1`：
    1. 清除标志：`predict_flag = 0`
    2. 保存当前滑动窗口索引（`window_head`, `window_tail`），保证时间一致
    3. 提取两个窗口索引内的100组加速度和角速度，计算特征、归一化
    4. 将特征输入到预训练的SVM模型中，执行预测
    5. 若模型结果为“跌倒”，设置 `alarm_flag`，触发报警响应
- **特点**：可以被中断，保证数据采集持续进行，同时预测只需在下一个窗口头到达前完成。
### 2.3 报警与显示

- **报警机制**：预测结果为跌倒时，设置alarm_flag>0。TIM3中断检测alarm_flag，若大于0则BEEP=1（蜂鸣器响），并递减alarm_flag，归零后停止报警。
- **屏幕显示**：实时显示加速度、预测结果、部分特征值等信息，便于现场监控。
### 2.4 按键控制

- **功能切换**：通过按键可独立开启/关闭数据上传、预测和报警功能，适应不同场景需求。

---

## 3. 关键实现要点

- **双中断异步设计**：数据采集与预测完全解耦，保证预测时采集不中断，保证实时性和可靠性。
- **滑动窗口机制**：循环队列设计，扩展特征维度的同时，让预测只需在下一个窗口头到达前完成即可（约500ms），不会丢失数据。
- **自定义数据帧**：串口上传采用帧头、功能字、长度、数据、校验和结构，兼容上位机解析。
- **无阻塞报警**：报警计数器配合中断实现蜂鸣器控制，无需延时函数，避免阻塞。
- **可视化与交互**：屏幕显示与按键控制提升用户体验和调试效率。

---

## 4. 适用场景

- 老人跌倒检测、健康监护
- 运动姿态分析
- 需要高实时性、低功耗的嵌入式动作识别场合

---

**本系统结构清晰，实时性强，适合嵌入式跌倒检测等动作识别应用。**